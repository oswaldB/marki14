---
export const prerender = true;

interface Props {
  title: string;
  withAuth?: boolean;
  currentPath?: string;
  hideSidebar?: boolean;}

const { title, withAuth = false, currentPath = '', hideSidebar = false } = Astro.props;

// Debug: Log the props to ensure they're being passed correctly
console.log('BaseLayout props:', { title, withAuth, currentPath, hideSidebar });

import SideMenu from '../components/SideMenu.astro';
import DockComponent from '../components/DockComponent.astro';
---

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{title} — Marki</title>
  <style is:global>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    [x-cloak] { display: none !important; }
  </style>
  <!-- Approche Hybride: Parse pour Auth + Fastify pour Cloud Functions -->
  <script is:inline src="https://unpkg.com/parse@5.3.0/dist/parse.min.js"></script>
  <script is:inline>
    // Configuration Hybride: Parse (Auth) + Fastify (Cloud Functions)
    if (typeof window !== 'undefined') {
      // 1. Configurer Parse UNIQUEMENT pour l'authentification
      const appId = 'marki';
      const jsKey = 'Careless7-Gore4-Guileless0-Jogger5-Clubbed9';
      const serverUrl = 'https://dev.parse.markidiags.com';
      
      Parse.initialize(appId, jsKey);
      Parse.serverURL = serverUrl;
      console.log('✅ Parse SDK initialisé pour AUTH:', serverUrl);
      
      // 2. Configurer Fastify pour les Cloud Functions
      window.FASTIFY_API_BASE = 'https://dev.api.markidiags.com/api';
      console.log('✅ Fastify API configurée pour CLOUD:', window.FASTIFY_API_BASE);
      
      // 3. Charger l'adaptateur Fastify
      import('/js/api/fastifyAdapter.js').then(module => {
        console.log('✅ Adaptateur Fastify chargé - Cloud Functions redirigées');
      }).catch(error => {
        console.error('❌ Erreur de chargement de l\'adaptateur Fastify:', error);
      });
    }
  </script>
</head>
<body class="bg-gray-50">
  <!-- Script d'authentification conditionnel -->
  <script is:inline define:vars={{withAuth: withAuth}}>
    // Code d'authentification - uniquement côté client
    if (typeof window !== 'undefined') {
      // S'assurer que withAuth est défini et est un booléen
      const authEnabled = Boolean(withAuth);
      console.log('Authentification:', authEnabled ? 'activée' : 'désactivée');
      
      if (authEnabled) {
        window.addEventListener('DOMContentLoaded', async () => {
          // Attendre que Parse SDK soit complètement initialisé (pour AUTH)
          await new Promise(resolve => {
            if (typeof Parse !== 'undefined' && Parse.serverURL) {
              resolve();
            } else {
              const checkParse = setInterval(() => {
                if (typeof Parse !== 'undefined' && Parse.serverURL) {
                  clearInterval(checkParse);
                  resolve();
                }
              }, 50);
            }
          });

          const sessionToken = sessionStorage.getItem('parseSessionToken') || localStorage.getItem('parseSessionToken');
          const isPersistent = !!localStorage.getItem('parseSessionToken');

          if (sessionToken) {
            try {
              // Restaurer la session avec le token (Parse gère l'auth)
              const user = await Parse.User.become(sessionToken);
              const newToken = user.getSessionToken();
              
              // Re-sauvegarder le token dans le bon stockage selon l'origine
              if (isPersistent) {
                localStorage.setItem('parseSessionToken', newToken);
                console.log('✅ Session persistante restaurée (Parse Auth)');
              } else {
                sessionStorage.setItem('parseSessionToken', newToken);
                console.log('✅ Session temporaire restaurée (Parse Auth)');
              }
            } catch (error) {
              console.error('❌ Token invalide (Parse Auth):', error);
              // Supprimer le token invalide des deux stockages
              sessionStorage.removeItem('parseSessionToken');
              localStorage.removeItem('parseSessionToken');
              const currentPath = window.location.pathname;
              window.location.href = '/login?redirect=' + encodeURIComponent(currentPath);
            }
          } else {
            // Pas de token, redirection vers login
            const currentPath = window.location.pathname;
            window.location.href = '/login?redirect=' + encodeURIComponent(currentPath);
          }
        });
      }
    }
  </script>
  <!-- Layout principal avec sidebar -->
  <div class="flex min-h-screen h-screen">
    <!-- Sidebar - conditionnellement affichée -->
    {hideSidebar ? null : (
      <aside class="w-80 bg-white border-r border-gray-200 hidden md:block flex-shrink-0 h-screen relative">
        <SideMenu currentPath={currentPath} />
      </aside>
    )}
    
    <!-- Contenu principal -->
    <main class={"flex-1 flex flex-col " + (hideSidebar ? " w-full" : "") + " overflow-y-auto pb-3 md:pb-0"}>
      <slot />
    </main>
  </div>
  
  <!-- Dock mobile - toujours affiché mais visible uniquement sur mobile -->
  <DockComponent>
    <SideMenu currentPath={currentPath} />
  </DockComponent>
  
</html>
