<!--
  Page: Import Manuel d'Impayés
  Description: Permet aux utilisateurs admin/comptable d'importer manuellement des impayés depuis un fichier CSV
  Auth: withAuth=true (réservé aux rôles admin et comptable)
  Date: 2026-02-16
-->
---
import BaseLayout from '../../layouts/BaseLayout.astro';

const withAuth = true;
const requiredRoles = ['admin', 'comptable'];
---

<BaseLayout title="Import Manuel d'Impayés" withAuth={withAuth} requiredRoles={requiredRoles}>
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Import Manuel d'Impayés</h1>

    <!-- Zone de téléchargement -->
    <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
      <div class="flex items-center space-x-4">
        <input 
          type="file" 
          @change="handleFile($event)" 
          accept=".csv,.xlsx" 
          class="block w-full text-sm text-gray-500"
          id="file-upload"
        >
        <button 
          @click="downloadTemplate()" 
          class="bg-[#00BDCF] text-white px-4 py-2 rounded-md hover:bg-[#00ADC0] transition-colors whitespace-nowrap"
        >
          <i class="fas fa-download mr-2"></i>
          Télécharger modèle
        </button>
      </div>
    </div>

    <!-- Aperçu des données -->
    <div x-show="preview.length > 0" class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Aperçu (5 premières lignes)</h3>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Montant</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Échéance</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rôle</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">URL Facture</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="row in preview" :key="$index">
              <tr>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="row[mapping.email]"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="row[mapping.amount]"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="row[mapping.dueDate]"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="row[mapping.role]"></td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="row[mapping.url] || 'N/A'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mapping des colonnes -->
    <div x-show="preview.length > 0" class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Mapping des colonnes</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
          <select x-model="mapping.email" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="email_contact">email_contact</option>
            <option value="email">email</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Montant</label>
          <select x-model="mapping.amount" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="montant">montant</option>
            <option value="amount">amount</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Échéance</label>
          <select x-model="mapping.dueDate" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="date_echeance">date_echeance</option>
            <option value="due_date">due_date</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Rôle</label>
          <select x-model="mapping.role" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="role_contact">role_contact</option>
            <option value="role">role</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">URL Facture</label>
          <select x-model="mapping.url" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="url_facture">url_facture</option>
            <option value="invoice_url">invoice_url</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Numéro Facture</label>
          <select x-model="mapping.num" class="w-full px-3 py-2 border border-gray-300 rounded-md">
            <option value="num_facture">num_facture</option>
            <option value="invoice_number">invoice_number</option>
          </select>
        </div>
      </div>

      <div class="mt-4">
        <label class="flex items-center">
          <input type="checkbox" x-model="skipHeader" class="h-4 w-4 text-[#007ACE] focus:ring-[#007ACE] border-gray-300 rounded">
          <span class="ml-2 block text-sm text-gray-700">Ignorer la première ligne (en-têtes)</span>
        </label>
      </div>
    </div>

    <!-- Actions -->
    <div x-show="preview.length > 0" class="flex items-center space-x-4">
      <button 
        @click="validateImport()"
        :disabled="loading"
        class="bg-[#007ACE] text-white px-6 py-2 rounded-md hover:bg-[#006BCE] transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <span x-show="!loading">Valider</span>
        <span x-show="loading">Import en cours...</span>
      </button>

      <button 
        @click="file = null; preview = [];"
        class="bg-gray-200 text-gray-800 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors"
      >
        Annuler
      </button>
    </div>

    <!-- Messages -->
    <div x-show="error" class="mt-4 bg-red-50 border border-red-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="fas fa-exclamation-circle text-red-400 text-lg"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-red-800">Erreur</p>
          <p class="text-sm text-red-700" x-text="error"></p>
        </div>
      </div>
    </div>

    <div x-show="successMessage" class="mt-4 bg-[#00CF9B] bg-opacity-20 border border-[#00CF9B] rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <i class="fas fa-check-circle text-[#00CF9B] text-lg"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-[#00CF9B]">Succès</p>
          <p class="text-sm text-gray-700" x-text="successMessage"></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Script Alpine.js -->
  <script>
    console.log('Chargement du state importManualState...');
  </script>
  <script src="/js/pages/importManualState.js" defer is:inline></script>
</BaseLayout>