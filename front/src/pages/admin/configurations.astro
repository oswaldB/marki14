<!--
  Page de gestion des configurations de synchronisation
  Conforme au Style Guide et aux bonnes pratiques Alpine.js
-->

---
import BaseLayout from '../../layouts/BaseLayout.astro';
---

<BaseLayout
  title="Gestion des Configurations"
  withAuth={true}
  Alpinefile="/js/pages/configurationsState.js"
>
  <div class="container mx-auto px-4 py-8" x-data="configurationsState()" x-init="init()">
    <!-- En-tête avec titre et boutons d'action -->
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Gestion des Configurations de Synchronisation</h1>
      <div class="space-x-4">
        <button @click="refreshConfigs()" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
          <i class="fas fa-sync-alt mr-2"></i> Rafraîchir
        </button>
        <button @click="showNewConfigForm()" class="bg-[#007ACE] text-white px-4 py-2 rounded-md hover:bg-[#006BCE] transition-colors">
          <i class="fas fa-plus mr-2"></i> Nouvelle Configuration
        </button>
      </div>
    </div>

    <!-- Filtres -->
    <div class="mb-6">
      <div class="flex items-center space-x-4">
        <input
          type="text"
          x-model="searchQuery"
          placeholder="Rechercher..."
          class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all"
        >
        <select x-model="filterStatus" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
          <option value="all">Toutes</option>
          <option value="active">Actives</option>
          <option value="inactive">Désactivées</option>
        </select>
      </div>
    </div>

    <!-- Tableau des configurations -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">BDD</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fréquence</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Statut</th>
            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <template x-for="config in filteredConfigs" :key="config.configId">
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900" x-text="config.name"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="config.dbConfig.database"></td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="config.frequency"></td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                  :class="config.status === 'Actif' ? 'bg-[#00CF9B] text-white' : 'bg-gray-200 text-gray-800'"
                  x-text="config.status"
                ></span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button @click="editConfig(config.configId)" class="text-[#007ACE] hover:text-[#006BCE] mr-2 transition-colors">
                  <i class="fas fa-edit"></i>
                </button>
                <button @click="testConfig(config.configId)" class="text-[#00BDCF] hover:text-[#00ADC0] mr-2 transition-colors">
                  <i class="fas fa-vial"></i>
                </button>
                <button @click="deleteConfig(config.configId)" class="text-red-500 hover:text-red-600 transition-colors">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </template>
          <tr x-show="filteredConfigs.length === 0">
            <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
              Aucune configuration trouvée
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Modal pour le formulaire de nouvelle configuration -->
    <div x-show="showForm" @click.away="closeForm" class="fixed inset-0 overflow-hidden z-50" style="display: none;">
      <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-y-0 right-0 pl-10 max-w-full flex sm:pl-16">
          <div class="relative w-screen max-w-2xl">
            <div class="h-full flex flex-col py-6 bg-white shadow-xl overflow-y-scroll">
              <div class="px-4 sm:px-6">
                <div class="flex items-start justify-between">
                  <h2 class="text-lg font-medium text-gray-900">
                    <span x-text="formTitle"></span>
                  </h2>
                  <div class="ml-3 h-7 flex items-center">
                    <button @click="closeForm" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none transition-colors">
                      <span class="sr-only">Fermer</span>
                      <i class="fas fa-times text-xl"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="mt-6 relative flex-1 px-4 sm:px-6">
                <!-- Formulaire de configuration -->
                <form @submit.prevent="saveConfig" class="space-y-6">
                  <div>
                    <label for="configName" class="block text-sm font-medium text-gray-700 mb-1">Nom</label>
                    <input type="text" id="configName" x-model="currentConfig.name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                  </div>

                  <div>
                    <label for="configId" class="block text-sm font-medium text-gray-700 mb-1">ID</label>
                    <input type="text" id="configId" x-model="currentConfig.configId" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                  </div>

                  <div>
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="description" x-model="currentConfig.description"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all" rows="3"></textarea>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <h3 class="text-sm font-medium text-gray-700 mb-3">Configuration Base de Données</h3>
                      <div class="space-y-4">
                        <div>
                          <label for="dbHost" class="block text-sm font-medium text-gray-700 mb-1">Hôte</label>
                          <input type="text" id="dbHost" x-model="currentConfig.dbConfig.host" required
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        </div>
                        <div>
                          <label for="dbName" class="block text-sm font-medium text-gray-700 mb-1">Base de données</label>
                          <input type="text" id="dbName" x-model="currentConfig.dbConfig.database" required
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        </div>
                        <div>
                          <label for="dbUser" class="block text-sm font-medium text-gray-700 mb-1">Utilisateur</label>
                          <input type="text" id="dbUser" x-model="currentConfig.dbConfig.user" required
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        </div>
                        <div>
                          <label for="dbPassword" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
                          <input type="password" id="dbPassword" x-model="currentConfig.dbConfig.password" required
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        </div>
                      </div>
                    </div>

                    <div>
                      <h3 class="text-sm font-medium text-gray-700 mb-3">Configuration Parse</h3>
                      <div class="space-y-4">
                        <div>
                          <label for="sqlQuery" class="block text-sm font-medium text-gray-700 mb-1">Requête SQL</label>
                          <textarea id="sqlQuery" x-model="currentConfig.dbConfig.query" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all" rows="4"></textarea>
                        </div>
                        <div>
                          <label for="mappings" class="block text-sm font-medium text-gray-700 mb-1">Mappings</label>
                          <input type="text" id="mappings" x-model="currentConfig.parseConfig.mappings" required
                                 placeholder="email→email_contact, amount→montant"
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        </div>
                        <div>
                          <label for="targetClass" class="block text-sm font-medium text-gray-700 mb-1">Classe cible</label>
                          <select id="targetClass" x-model="currentConfig.parseConfig.targetClass" required
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                            <option value="">Sélectionnez une classe</option>
                            <option value="Impayes">Impayes</option>
                            <!-- Ajouter d'autres classes au besoin -->
                          </select>
                        </div>
                        <div>
                          <label for="requiredFields" class="block text-sm font-medium text-gray-700 mb-1">Champs requis</label>
                          <input type="text" id="requiredFields" x-model="currentConfig.validationRules.requiredFields" required
                                 placeholder="email, amount, due_date"
                                 class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                      <label for="frequency" class="block text-sm font-medium text-gray-700 mb-1">Fréquence</label>
                      <select id="frequency" x-model="currentConfig.frequency" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        <option value="">Sélectionnez une fréquence</option>
                        <option value="Quotidienne">Quotidienne</option>
                        <option value="Hebdomadaire">Hebdomadaire</option>
                        <option value="Mensuelle">Mensuelle</option>
                        <option value="Manuelle">Manuelle</option>
                      </select>
                    </div>

                    <div>
                      <label for="status" class="block text-sm font-medium text-gray-700 mb-1">Statut</label>
                      <select id="status" x-model="currentConfig.status" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#007ACE] transition-all">
                        <option value="Actif">Actif</option>
                        <option value="Désactivé">Désactivé</option>
                      </select>
                    </div>
                  </div>

                  <div class="flex justify-end space-x-4">
                    <button type="button" @click="closeForm" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                      Annuler
                    </button>
                    <button type="submit" class="bg-[#007ACE] text-white px-4 py-2 rounded-md hover:bg-[#006BCE] transition-colors">
                      Enregistrer
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal pour les résultats de test -->
    <div x-show="showTestResults" @click.away="closeTestResults" class="fixed inset-0 overflow-hidden z-50" style="display: none;">
      <div class="absolute inset-0 overflow-hidden">
        <div class="absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
        <div class="fixed inset-y-0 right-0 pl-10 max-w-full flex sm:pl-16">
          <div class="relative w-screen max-w-2xl">
            <div class="h-full flex flex-col py-6 bg-white shadow-xl overflow-y-scroll">
              <div class="px-4 sm:px-6">
                <div class="flex items-start justify-between">
                  <h2 class="text-lg font-medium text-gray-900">Résultats du Test</h2>
                  <div class="ml-3 h-7 flex items-center">
                    <button @click="closeTestResults" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none transition-colors">
                      <span class="sr-only">Fermer</span>
                      <i class="fas fa-times text-xl"></i>
                    </button>
                  </div>
                </div>
              </div>
              <div class="mt-6 relative flex-1 px-4 sm:px-6">
                <div x-show="testError" class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
                  <div class="flex">
                    <div class="flex-shrink-0">
                      <i class="fas fa-exclamation-circle text-red-400 text-lg"></i>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm font-medium text-red-800">Erreur</p>
                      <p class="text-sm text-red-700" x-text="testError"></p>
                    </div>
                  </div>
                </div>

                <div x-show="!testError" class="space-y-4">
                  <div class="bg-[#00CF9B] bg-opacity-20 border border-[#00CF9B] rounded-md p-4">
                    <div class="flex">
                      <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-[#00CF9B] text-lg"></i>
                      </div>
                      <div class="ml-3">
                        <p class="text-sm font-medium text-[#00CF9B]">Succès</p>
                        <p class="text-sm text-gray-700" x-text="testSuccessMessage"></p>
                      </div>
                    </div>
                  </div>

                  <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                      <thead class="bg-gray-50">
                        <tr>
                          <template x-for="column in testColumns" :key="column">
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" x-text="column"></th>
                          </template>
                        </tr>
                      </thead>
                      <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="row in testData" :key="row.id">
                          <tr>
                            <template x-for="column in testColumns">
                              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="row[column.toLowerCase()]"></td>
                            </template>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="border-t border-gray-200 px-4 py-4 sm:px-6">
                <button @click="closeTestResults" class="w-full bg-[#007ACE] text-white py-2 px-4 rounded-md hover:bg-[#006BCE] transition-colors">
                  Fermer
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Alertes -->
    <div class="fixed bottom-4 right-4 space-y-2 z-50">
      <template x-for="alert in alerts" :key="alert.id">
        <div class="bg-[#00CF9B] bg-opacity-20 border border-[#00CF9B] rounded-md p-4 transition-all duration-300 ease-in-out" x-show="alert.type === 'success'">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-check-circle text-[#00CF9B] text-lg"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-[#00CF9B]">Succès</p>
              <p class="text-sm text-gray-700" x-text="alert.message"></p>
            </div>
          </div>
        </div>
        <div class="bg-red-50 border border-red-200 rounded-md p-4 transition-all duration-300 ease-in-out" x-show="alert.type === 'error'">
          <div class="flex">
            <div class="flex-shrink-0">
              <i class="fas fa-exclamation-circle text-red-400 text-lg"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium text-red-800">Erreur</p>
              <p class="text-sm text-red-700" x-text="alert.message"></p>
            </div>
          </div>
        </div>
      </template>
    </div>
  </div>
</BaseLayout>