<!--
  ~ src/pages/superadmin.astro
  ~ Page d'administration pour les super-administrateurs
  ~ Permet de lancer les scripts d'initialisation et de synchronisation
-->

---
import BaseLayout from '../layouts/BaseLayout.astro';
import { Plus } from '@lucide/astro';
---
<!--
    ~ Script Alpine.js pour g√©rer l'ex√©cution des scripts
    ~ Code int√©gr√© directement dans le fichier Astro pour √©viter les probl√®mes de chargement
  -->
  <script is:inline>
    /**
     * superadminState.js
     * 
     * Composant Alpine.js pour g√©rer l'ex√©cution des scripts d'administration
     * sur la page superadmin.astro
     */
    document.addEventListener('alpine:init', () => {
      Alpine.data('superadminState', () => ({
        // √âtat initial
        isLoading: {
          initCollections: false,
          syncImpayes: false
        },
        // Logs des scripts
        scriptLogs: '',
        
        // √âtat pour la gestion des utilisateurs
        users: [],
        userSearchTerm: '',
        currentUserId: null,
        isUserFormOpen: false,
        currentUser: null,
        userForm: {
          firstName: '',
          lastName: '',
          email: '',
          password: '',
          is_admin: false
        },

        /**
         * Initialisation du composant
         */
        async init() {
            // Charger les utilisateurs
            await this.loadUsers();
            
            // Charger l'ID de l'utilisateur actuel
            const currentUser = Parse.User.current();
            if (currentUser) {
                this.currentUserId = currentUser.id;
            }
        },
          


        /**
         * Ex√©cute un script d'administration
         * @param {string} scriptName - Nom du script √† ex√©cuter ('initCollections' ou 'syncImpayes')
         */
        async runScript(scriptName) {
          // V√©rifier que l'utilisateur est bien un superadmin
          const currentUser = Parse.User.current();
          if (!currentUser) {
            this.addLog('Erreur: Utilisateur non connect√©', 'error');
            return;
          }

          // V√©rifier le r√¥le superadmin (√† impl√©menter c√¥t√© serveur)
          // Pour l'instant, on suppose que seul un superadmin peut acc√©der √† cette page

          // Mettre √† jour l'√©tat de chargement
          this.isLoading[scriptName] = true;
          this.addLog(`D√©but de l'ex√©cution du script: ${scriptName}`);

          try {
            // Appeler la fonction cloud correspondante
            const response = await Parse.Cloud.run(scriptName);
            
            this.addLog(`Script ${scriptName} ex√©cut√© avec succ√®s`, 'success');
            this.addLog(`R√©sultat: ${JSON.stringify(response, null, 2)}`);
          } catch (error) {
            // Gestion sp√©cifique des erreurs 502 (Bad Gateway)
            if (error.message.includes('502') || error.message.includes('Bad Gateway')) {
              this.addLog(`Erreur 502: Le serveur Parse est indisponible`, 'error');
              this.addLog(`Veuillez v√©rifier que le serveur Parse est en cours d'ex√©cution`, 'error');
            } else {
              this.addLog(`Erreur lors de l'ex√©cution du script ${scriptName}`, 'error');
              this.addLog(`D√©tails: ${error.message}`, 'error');
            }
            console.error('Erreur d√©taill√©e:', error);
          } finally {
            // R√©initialiser l'√©tat de chargement
            this.isLoading[scriptName] = false;
          }
        },

        /**
         * Ajoute un message aux logs
         * @param {string} message - Message √† ajouter
         * @param {string} [type='info'] - Type de message ('info', 'success', 'error', 'warning')
         */
        addLog(message, type = 'info') {
          const timestamp = new Date().toISOString();
          const logTypes = {
            info: '[INFO]',
            success: '[SUCCESS]',
            error: '[ERROR]',
            warning: '[WARNING]'
          };
          
          const logClasses = {
            info: 'text-blue-600',
            success: 'text-green-600',
            error: 'text-red-600',
            warning: 'text-yellow-600'
          };
          
          const logMessage = `[${timestamp}] <span class="${logClasses[type] || logClasses.info}">${logTypes[type] || '[INFO]'}</span> ${message}`;
          
          // Ajouter le message aux logs existants
          this.scriptLogs = this.scriptLogs ? `${this.scriptLogs}\n${logMessage}` : logMessage;
          
          // Faire d√©filer vers le bas
          this.$nextTick(() => {
            const logsContainer = document.getElementById('scriptLogs');
            if (logsContainer) {
              logsContainer.scrollTop = logsContainer.scrollHeight;
            }
          });
        },

        /**
         * Efface les logs
         */
        clearLogs() {
          this.scriptLogs = '';
          this.addLog('Logs effac√©s');
        },

        // √âtat pour le test SFTP
        sftpTest: {
          isLoading: false,
          host: '',
          port: '',
          username: '',
          password: '',
          testPath: '/',
          useEnvCredentials: true
        },
        
        // √âtat pour la g√©n√©ration du sch√©ma
        schemaGeneration: {
          isLoadingFullSchema: false,
          isLoadingImpayesColumns: false,
          fullSchemaResult: null,
          impayesColumnsResult: null
        },

        /**
         * Initialiser les champs SFTP avec les valeurs par d√©faut
         */
        initSftpForm() {
          // Ne r√©initialiser que si on utilise les identifiants .env
          if (this.sftpTest.useEnvCredentials) {
            this.sftpTest = {
              ...this.sftpTest,
              host: '',
              port: '2222',
              username: '',
              password: '',
              testPath: '/'
            };
          }
        },
        
        /**
         * G√©n√©rer et afficher le sch√©ma complet
         */
        async generateFullSchema() {
          this.schemaGeneration.isLoadingFullSchema = true;
          this.schemaGeneration.fullSchemaResult = null;
          this.addLog('üìä D√©but de la g√©n√©ration du sch√©ma complet...');
          
          try {
            const response = await Parse.Cloud.run('getFullSchema');
            
            if (response.success) {
              this.schemaGeneration.fullSchemaResult = response.schema;
              this.addLog(`‚úÖ Sch√©ma complet g√©n√©r√© avec succ√®s !`, 'success');
              this.addLog(`   Classes trouv√©es: ${Object.keys(response.schema).filter(k => k !== 'timestamp').join(', ')}`);
            } else {
              this.addLog(`‚ùå Erreur lors de la g√©n√©ration du sch√©ma: ${response.message}`, 'error');
              if (response.error) {
                this.addLog(`   D√©tails: ${response.error}`, 'error');
              }
            }
          } catch (error) {
            this.addLog(`‚ùå Erreur lors de la g√©n√©ration du sch√©ma: ${error.message}`, 'error');
            console.error('Erreur de g√©n√©ration de sch√©ma:', error);
          } finally {
            this.schemaGeneration.isLoadingFullSchema = false;
            this.addLog('üìä G√©n√©ration du sch√©ma complet termin√©e');
          }
        },
        
        /**
         * G√©n√©rer et afficher les colonnes des impay√©s
         */
        async generateImpayesColumns() {
          this.schemaGeneration.isLoadingImpayesColumns = true;
          this.schemaGeneration.impayesColumnsResult = null;
          this.addLog('üìã D√©but de la g√©n√©ration des colonnes des impay√©s...');
          
          try {
            const response = await Parse.Cloud.run('getImpayesColumns');
            
            if (response.success) {
              this.schemaGeneration.impayesColumnsResult = {
                columns: response.columns,
                count: response.count
              };
              this.addLog(`‚úÖ Colonnes des impay√©s g√©n√©r√©es avec succ√®s !`, 'success');
              this.addLog(`   Nombre de colonnes: ${response.count}`);
            } else {
              this.addLog(`‚ùå Erreur lors de la g√©n√©ration des colonnes: ${response.message}`, 'error');
              if (response.error) {
                this.addLog(`   D√©tails: ${response.error}`, 'error');
              }
            }
          } catch (error) {
            this.addLog(`‚ùå Erreur lors de la g√©n√©ration des colonnes: ${error.message}`, 'error');
            console.error('Erreur de g√©n√©ration des colonnes:', error);
          } finally {
            this.schemaGeneration.isLoadingImpayesColumns = false;
            this.addLog('üìã G√©n√©ration des colonnes des impay√©s termin√©e');
          }
        },

        /**
         * Tester la connexion SFTP
         */
        async testSftpConnection() {
          this.sftpTest.isLoading = true;
          this.addLog('üîå D√©but du test de connexion SFTP...');

          try {
            const params = this.sftpTest.useEnvCredentials ? {} : {
              host: this.sftpTest.host,
              port: this.sftpTest.port,
              username: this.sftpTest.username,
              password: this.sftpTest.password,
              testPath: this.sftpTest.testPath
            };

            this.addLog(`   Utilisation des identifiants: ${this.sftpTest.useEnvCredentials ? 'fichier .env' : 'personnalis√©s'}`);

            const response = await Parse.Cloud.run('testSftpConnection', params);

            if (response.success) {
              this.addLog(`‚úÖ Test SFTP r√©ussi !`, 'success');
              this.addLog(`   Temps de connexion: ${response.connectionTime}ms`);
              
              // Afficher les logs d√©taill√©s
              if (response.logs && response.logs.length > 0) {
                response.logs.forEach(log => this.addLog(`   ${log}`));
              }
            } else {
              this.addLog(`‚ùå Test SFTP √©chou√©: ${response.message}`, 'error');
              
              // Afficher les logs d√©taill√©s
              if (response.logs && response.logs.length > 0) {
                response.logs.forEach(log => this.addLog(`   ${log}`));
              }
            }

          } catch (error) {
            this.addLog(`‚ùå Erreur lors du test SFTP: ${error.message}`, 'error');
            console.error('Erreur SFTP:', error);
          } finally {
            this.sftpTest.isLoading = false;
            this.addLog('üîå Test SFTP termin√©');
          }
        },

        // M√©thodes pour la gestion des utilisateurs
        
        /**
         * Charger tous les utilisateurs
         */
        async loadUsers() {
            try {
                this.users = await Parse.Cloud.run('getAllUsers');
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
                this.addLog(`‚ùå Erreur lors du chargement des utilisateurs: ${error.message}`, 'error');
            }
        },

        /**
         * Rechercher des utilisateurs
         */
        async searchUsers() {
            try {
                if (this.userSearchTerm.trim() === '') {
                    await this.loadUsers();
                } else {
                    this.users = await Parse.Cloud.run('searchUsers', { searchTerm: this.userSearchTerm });
                }
            } catch (error) {
                console.error('Erreur lors de la recherche d\'utilisateurs:', error);
                this.addLog(`‚ùå Erreur lors de la recherche d\'utilisateurs: ${error.message}`, 'error');
            }
        },

        /**
         * Ouvrir le formulaire d'utilisateur
         */
        openUserForm() {
            this.resetUserForm();
            this.currentUser = null;
            this.isUserFormOpen = true;
        },

        /**
         * Modifier un utilisateur
         */
        async editUser(userId) {
            try {
                const user = await Parse.Cloud.run('getUserDetails', { objectId: userId });
                this.userForm = {
                    firstName: user.firstName,
                    lastName: user.lastName,
                    email: user.email,
                    password: '',
                    is_admin: user.is_admin
                };
                this.currentUser = user;
                this.isUserFormOpen = true;
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration de l\'utilisateur:', error);
                this.addLog(`‚ùå Erreur lors de la r√©cup√©ration de l\'utilisateur: ${error.message}`, 'error');
            }
        },

        /**
         * Supprimer un utilisateur
         */
        async deleteUser(userId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cet utilisateur ?')) {
                try {
                    await Parse.Cloud.run('deleteUser', { objectId: userId });
                    await this.loadUsers();
                    this.addLog(`üóëÔ∏è Utilisateur supprim√© avec succ√®s`, 'success');
                } catch (error) {
                    console.error('Erreur lors de la suppression de l\'utilisateur:', error);
                    this.addLog(`‚ùå Erreur lors de la suppression de l\'utilisateur: ${error.message}`, 'error');
                }
            }
        },

        /**
         * R√©initialiser le formulaire d'utilisateur
         */
        resetUserForm() {
            this.userForm = {
                firstName: '',
                lastName: '',
                email: '',
                password: '',
                is_admin: false
            };
        },

        /**
         * Sauvegarder un utilisateur
         */
        async saveUser() {
            try {
                // Validation
                if (!this.userForm.firstName || !this.userForm.lastName || !this.userForm.email) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }

                const params = {
                    firstName: this.userForm.firstName,
                    lastName: this.userForm.lastName,
                    email: this.userForm.email,
                    is_admin: this.userForm.is_admin
                };

                // Ajouter le mot de passe uniquement s'il est fourni
                if (this.userForm.password) {
                    params.password = this.userForm.password;
                }

                let result;
                if (this.currentUser) {
                    // Mise √† jour
                    params.objectId = this.currentUser.objectId;
                    result = await Parse.Cloud.run('updateUser', params);
                    this.addLog(`üìù Utilisateur mis √† jour avec succ√®s`, 'success');
                } else {
                    // Cr√©ation
                    if (!params.password) {
                        alert('Le mot de passe est obligatoire pour la cr√©ation d\'un utilisateur');
                        return;
                    }
                    result = await Parse.Cloud.run('createUser', params);
                    this.addLog(`üë§ Utilisateur cr√©√© avec succ√®s`, 'success');
                }

                // Recharger les utilisateurs et fermer le formulaire
                await this.loadUsers();
                this.isUserFormOpen = false;
                
            } catch (error) {
                console.error('Erreur lors de la sauvegarde de l\'utilisateur:', error);
                this.addLog(`‚ùå Erreur lors de la sauvegarde de l\'utilisateur: ${error.message}`, 'error');
            }
        }
      }));
    });
  </script>
<BaseLayout>
  <div class="container mx-auto px-4 py-8" x-data="superadminState()" x-init="init()">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Super Admin Dashboard</h1>

    <!--
      ~ Section des scripts d'administration
      ~ Contient les boutons pour lancer les scripts
    -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Scripts d'administration</h2>
      <p class="text-gray-600 mb-6">Cette section permet de lancer les scripts d'initialisation et de synchronisation.</p>

      <div class="space-y-4">
        <!-- Bouton pour initialiser les collections -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <h3 class="font-medium text-gray-900">Initialiser les collections</h3>
            <p class="text-sm text-gray-500">Lance le script initCollections.js</p>
          </div>
          <button
            id="initCollectionsBtn"
            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            @click="runScript('initCollections')"
            :disabled="isLoading.initCollections"
          >
            <span x-show="!isLoading.initCollections">Ex√©cuter</span>
            <span x-show="isLoading.initCollections" class="flex items-center">
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Ex√©cution...
            </span>
          </button>
        </div>

        <!-- Bouton pour synchroniser les impay√©s -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <h3 class="font-medium text-gray-900">Synchroniser les impay√©s</h3>
            <p class="text-sm text-gray-500">Lance le script syncImpayes.js</p>
          </div>
          <button
            id="syncImpayesBtn"
            class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
            @click="runScript('syncImpayes')"
            :disabled="isLoading.syncImpayes"
          >
            <span x-show="!isLoading.syncImpayes">Ex√©cuter</span>
            <span x-show="isLoading.syncImpayes" class="flex items-center">
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Ex√©cution...
            </span>
          </button>
        </div>
        
        <!-- Bouton pour g√©n√©rer le sch√©ma complet -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <h3 class="font-medium text-gray-900">G√©n√©rer le sch√©ma complet</h3>
            <p class="text-sm text-gray-500">R√©cup√®re et affiche le sch√©ma complet de toutes les classes</p>
          </div>
          <button
            id="generateFullSchemaBtn"
            class="px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
            @click="generateFullSchema()"
            :disabled="schemaGeneration.isLoadingFullSchema"
          >
            <span x-show="!schemaGeneration.isLoadingFullSchema">G√©n√©rer sch√©ma complet</span>
            <span x-show="schemaGeneration.isLoadingFullSchema" class="flex items-center">
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Chargement...
            </span>
          </button>
        </div>
        
        <!-- Bouton pour g√©n√©rer les colonnes des impay√©s -->
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <h3 class="font-medium text-gray-900">G√©n√©rer les colonnes des impay√©s</h3>
            <p class="text-sm text-gray-500">R√©cup√®re et affiche les colonnes de la classe Impayes</p>
          </div>
          <button
            id="generateImpayesColumnsBtn"
            class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            @click="generateImpayesColumns()"
            :disabled="schemaGeneration.isLoadingImpayesColumns"
          >
            <span x-show="!schemaGeneration.isLoadingImpayesColumns">G√©n√©rer colonnes impay√©s</span>
            <span x-show="schemaGeneration.isLoadingImpayesColumns" class="flex items-center">
              <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              Chargement...
            </span>
          </button>
        </div>
      </div>
    </div>

    <!--
      ~ Section d'affichage des r√©sultats du sch√©ma
      ~ Affiche les r√©sultats JSON des g√©n√©rations de sch√©ma
    -->
    <div class="bg-white shadow rounded-lg p-6 mb-8" x-show="schemaGeneration.fullSchemaResult || schemaGeneration.impayesColumnsResult">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">R√©sultats du sch√©ma</h2>
      
      <!-- R√©sultat du sch√©ma complet -->
      <div x-show="schemaGeneration.fullSchemaResult" class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-2">Sch√©ma complet</h3>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <pre class="text-sm overflow-x-auto" x-text="JSON.stringify(schemaGeneration.fullSchemaResult, null, 2)"></pre>
        </div>
        <button
          class="mt-2 px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300"
          @click="navigator.clipboard.writeText(JSON.stringify(schemaGeneration.fullSchemaResult, null, 2))"
        >
          Copier le JSON
        </button>
      </div>
      
      <!-- R√©sultat des colonnes des impay√©s -->
      <div x-show="schemaGeneration.impayesColumnsResult" class="mb-6">
        <h3 class="text-lg font-medium text-gray-900 mb-2">Colonnes des impay√©s</h3>
        <p class="text-sm text-gray-600 mb-2" x-text="`Nombre de colonnes: ${schemaGeneration.impayesColumnsResult.count}`"></p>
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <pre class="text-sm overflow-x-auto" x-text="JSON.stringify(schemaGeneration.impayesColumnsResult.columns, null, 2)"></pre>
        </div>
        <button
          class="mt-2 px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300"
          @click="navigator.clipboard.writeText(JSON.stringify(schemaGeneration.impayesColumnsResult.columns, null, 2))"
        >
          Copier le JSON
        </button>
      </div>
      
      <button
        class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-md hover:bg-red-700"
        @click="schemaGeneration.fullSchemaResult = null; schemaGeneration.impayesColumnsResult = null"
      >
        Effacer les r√©sultats
      </button>
    </div>

    <!--
      ~ Section de test SFTP
      ~ Permet de tester la connexion au serveur SFTP
    -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Test de connexion SFTP</h2>
        <button
          class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
          @click="initSftpForm()"
        >
          R√©initialiser
        </button>
      </div>
      
      <p class="text-gray-600 mb-6">
        Testez la connexion au serveur SFTP pour v√©rifier que les identifiants sont corrects
        et que le serveur est accessible. Utilisez soit les identifiants du fichier .env,
        soit entrez des identifiants personnalis√©s.
      </p>

      <div class="mb-4">
        <label class="flex items-center">
          <input
            type="checkbox"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
            x-model="sftpTest.useEnvCredentials"
            @change="sftpTest.useEnvCredentials ? initSftpForm() : ''"
          >
          <span class="ml-2 text-sm text-gray-700">Utiliser les identifiants du fichier .env</span>
        </label>
      </div>

      <!-- Formulaire pour les identifiants personnalis√©s -->
      <div x-show="!sftpTest.useEnvCredentials" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 transform scale-95" x-transition:enter-end="opacity-100 transform scale-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100 transform scale-100" x-transition:leave-end="opacity-0 transform scale-95" class="space-y-4 mb-6 mt-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="sftpHost" class="block text-sm font-medium text-gray-700 mb-1">H√¥te SFTP</label>
            <input
              type="text"
              id="sftpHost"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="sftpTest.host"
              placeholder="serveur.adti06.com"
            >
          </div>
          <div>
            <label for="sftpPort" class="block text-sm font-medium text-gray-700 mb-1">Port</label>
            <input
              type="number"
              id="sftpPort"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="sftpTest.port"
              placeholder="2222"
            >
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="sftpUsername" class="block text-sm font-medium text-gray-700 mb-1">Nom d'utilisateur</label>
            <input
              type="text"
              id="sftpUsername"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="sftpTest.username"
              placeholder="m.wegener"
            >
          </div>
          <div>
            <label for="sftpPassword" class="block text-sm font-medium text-gray-700 mb-1">Mot de passe</label>
            <input
              type="password"
              id="sftpPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="sftpTest.password"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            >
          </div>
        </div>

        <div>
          <label for="sftpTestPath" class="block text-sm font-medium text-gray-700 mb-1">Chemin de test</label>
          <input
            type="text"
            id="sftpTestPath"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            x-model="sftpTest.testPath"
            placeholder="/ADN/Reporting/Gco/Piece/"
          >
        </div>
      </div>

      <!-- Bouton de test -->
      <button
        class="w-full px-4 py-2 bg-blue-600 text-white font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 flex items-center justify-center"
        @click="testSftpConnection()"
        :disabled="sftpTest.isLoading"
      >
        <span x-show="!sftpTest.isLoading">Tester la connexion SFTP</span>
        <span x-show="sftpTest.isLoading" class="flex items-center">
          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Test en cours...
        </span>
      </button>
    </div>

    <!--
      ~ Section de gestion des utilisateurs
      ~ Permet de g√©rer les utilisateurs de l'application
    -->
    <div class="bg-white shadow rounded-lg p-6 mb-8">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Gestion des utilisateurs</h2>
      <p class="text-gray-600 mb-6">Cette section permet de g√©rer les utilisateurs de l'application.</p>

      <!-- Formulaire de recherche et d'ajout -->
      <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div class="flex-1">
          <label for="userSearch" class="block text-sm font-medium text-gray-700 mb-1">Rechercher un utilisateur</label>
          <input
            type="text"
            id="userSearch"
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
            x-model="userSearchTerm"
            placeholder="Rechercher par nom, pr√©nom ou email..."
            @input.debounce.500ms="searchUsers()"
          >
        </div>
        <div class="flex items-end">
          <button
            class="px-4 py-2 bg-green-600 text-white font-medium rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center"
            @click="openUserForm()"
          >
            <Plus class="w-4 h-4 mr-2" />
            Ajouter un utilisateur
          </button>
        </div>
      </div>

      <!-- Tableau des utilisateurs -->
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nom</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">R√¥le</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="user in users" :key="user.objectId">
              <tr>
                <td class="px-6 py-4 whitespace-nowrap" x-text="user.firstName + ' ' + user.lastName"></td>
                <td class="px-6 py-4 whitespace-nowrap" x-text="user.email"></td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span
                    class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                    :class="user.is_admin ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'"
                    x-text="user.is_admin ? 'Administrateur' : 'Utilisateur'"
                  ></span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                  <button
                    class="text-blue-600 hover:text-blue-900 mr-2"
                    @click="editUser(user.objectId)"
                  >
                    Modifier
                  </button>
                  <button
                    class="text-red-600 hover:text-red-900"
                    @click="deleteUser(user.objectId)"
                    :disabled="user.objectId === currentUserId"
                  >
                    Supprimer
                  </button>
                </td>
              </tr>
            </template>
            <tr x-show="users.length === 0">
              <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                Aucun utilisateur trouv√©
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!--
      ~ Section des logs
      ~ Affiche les logs des scripts ex√©cut√©s
    -->
    <div class="bg-white shadow rounded-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">Logs des scripts</h2>
        <button
          class="px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
          @click="clearLogs()"
        >
          Effacer les logs
        </button>
      </div>
      <div
        id="scriptLogs"
        class="h-64 overflow-y-auto bg-gray-50 p-4 rounded-lg border border-gray-200 text-sm font-mono whitespace-pre-wrap"
        x-html="scriptLogs"
      >
        <!-- Les logs seront affich√©s ici -->
      </div>
    </div>
  </div>

  
  <!-- Modal pour la gestion des utilisateurs -->
  <div
    x-show="isUserFormOpen"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    class="fixed inset-0 z-50 overflow-hidden bg-black bg-opacity-50 flex items-center justify-center p-4"
    @click.away="isUserFormOpen = false"
  >
    <div
      class="bg-white rounded-lg shadow-xl w-full max-w-md overflow-hidden"
      @click.stop
    >
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-gray-800" x-text="currentUser ? 'Modifier un utilisateur' : 'Ajouter un utilisateur'"></h2>
          <button @click="isUserFormOpen = false" class="text-gray-400 hover:text-gray-600">
            <X class="w-6 h-6" />
          </button>
        </div>

        <form class="space-y-4" @submit.prevent="saveUser">
          <div>
            <label for="userFirstName" class="block text-sm font-medium text-gray-700 mb-1">Pr√©nom *</label>
            <input
              type="text"
              id="userFirstName"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="userForm.firstName"
              required
            >
          </div>

          <div>
            <label for="userLastName" class="block text-sm font-medium text-gray-700 mb-1">Nom *</label>
            <input
              type="text"
              id="userLastName"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="userForm.lastName"
              required
            >
          </div>

          <div>
            <label for="userEmail" class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
            <input
              type="email"
              id="userEmail"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="userForm.email"
              required
            >
          </div>

          <div>
            <label for="userPassword" class="block text-sm font-medium text-gray-700 mb-1">
              Mot de passe <span x-show="!currentUser" class="text-red-500">*</span>
              <span x-show="currentUser" class="text-sm text-gray-500">(laisser vide pour ne pas changer)</span>
            </label>
            <input
              type="password"
              id="userPassword"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              x-model="userForm.password"
              :required="!currentUser"
            >
          </div>

          <div class="flex items-center">
            <input
              type="checkbox"
              id="userIsAdmin"
              class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
              x-model="userForm.is_admin"
            >
            <label for="userIsAdmin" class="ml-2 block text-sm text-gray-700">
              Administrateur
            </label>
          </div>

          <div class="flex justify-end space-x-3 mt-6">
            <button
              type="button"
              @click="isUserFormOpen = false"
              class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500"
            >
              Annuler
            </button>
            <button
              type="submit"
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              <span x-text="currentUser ? 'Mettre √† jour' : 'Ajouter'"></span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

</BaseLayout>
