---
// src/components/sequences/SequenceManagementDrawer.astro
import { X, FileText, Minus, Settings } from '@lucide/astro';
---
<script is:inline>
  document.addEventListener('alpine:init', () => {
    Alpine.store('sequenceManagement', {
      isOpen: false,
      selectedImpaye: null,
      sequences: [],
      isLoadingSequences: false,
      newSequenceName: '',
      newSequenceIsAutomatic: false,
      addingSequenceId: null,
      
      open(invoice) {
        this.isOpen = true;
        this.selectedImpaye = invoice;
        this.loadSequences();
      },
      
      close() {
        this.isOpen = false;
        this.selectedImpaye = null;
      },
      
      async loadSequences() {
        this.isLoadingSequences = true;
        try {
          // Logique pour charger les séquences depuis l'API
          // Cette partie devra être adaptée à votre API
          const response = await fetch('/api/sequences');
          this.sequences = await response.json();
        } catch (error) {
          console.error('Erreur lors du chargement des séquences:', error);
        } finally {
          this.isLoadingSequences = false;
        }
      },
      
      async createSequence(name, isAutomatic) {
        if (!name || name.trim() === '') return;
        
        try {
          // Logique pour créer une séquence
          const response = await fetch('/api/sequences', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              name: name,
              is_automatic: isAutomatic,
            }),
          });
          const newSequence = await response.json();
          this.sequences.push(newSequence);
          this.newSequenceName = '';
          this.newSequenceIsAutomatic = false;
        } catch (error) {
          console.error('Erreur lors de la création de la séquence:', error);
        }
      },
      
      async assignSequenceToInvoice(invoiceId, sequenceId) {
        if (!invoiceId) return;
        
        this.addingSequenceId = sequenceId;
        try {
          // Logique pour assigner une séquence à une facture
          await fetch(`/api/invoices/${invoiceId}/sequence`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              sequence_id: sequenceId,
            }),
          });
          
          // Mettre à jour la facture sélectionnée
          if (this.selectedImpaye) {
            this.selectedImpaye.sequence_id = sequenceId;
            const sequence = this.sequences.find(s => s.id === sequenceId);
            if (sequence) {
              this.selectedImpaye.sequence_name = sequence.name;
              this.selectedImpaye.sequence_is_automatic = sequence.is_automatic;
            } else {
              this.selectedImpaye.sequence_name = null;
              this.selectedImpaye.sequence_is_automatic = false;
            }
          }
        } catch (error) {
          console.error('Erreur lors de l\'assignment de la séquence:', error);
        } finally {
          this.addingSequenceId = null;
        }
      },
      
      formatDate(dateString) {
        if (!dateString) return 'Date inconnue';
        const date = new Date(dateString);
        return date.toLocaleDateString('fr-FR');
      }
    });
    
    console.log('Store sequenceManagement initialisé avec succès !');
  });
</script>

<!-- Sequence Management Drawer -->
<div x-data>
  <div 
    x-show="$store.sequenceManagement.isOpen"
    x-transition
    class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-end"
    data-sequence-drawer
  >
    <div class="bg-white h-full w-full md:w-1/2 shadow-xl relative" data-sequence-drawer-content>
      <div class="p-4 border-b border-gray-200 flex justify-between items-center" data-sequence-header>
        <h3 class="text-lg font-semibold text-gray-900">
          <template x-if="$store.sequenceManagement.selectedImpaye">
            <span>Gérer la séquence - Facture #</span>
            <span x-text="$store.sequenceManagement.selectedImpaye.nfacture"></span>
          </template>
          <template x-if="!$store.sequenceManagement.selectedImpaye">
            <span>Gestion des séquences</span>
          </template>
        </h3>
        <button 
          @click="$store.sequenceManagement.close()"
          class="text-gray-500 hover:text-gray-700"
          data-sequence-close
        >
          <X class="w-4 h-4" />
          Fermer
        </button>
      </div>
      
      <div class="p-4 h-[calc(100%-120px)] overflow-auto" data-sequence-content>
        <!-- Loading state for sequences -->
        <div x-show="$store.sequenceManagement.isLoadingSequences" class="text-center py-8">
          <div class="w-8 h-8 border-2 border-[#007ACE] border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
          <p class="text-gray-600 text-sm">Chargement des séquences...</p>
        </div>
        
        <!-- Content when loaded -->
        <div x-show="!$store.sequenceManagement.isLoadingSequences" class="space-y-4">
          <!-- Current sequence info (if editing a specific invoice) -->
          <div x-show="$store.sequenceManagement.selectedImpaye" class="bg-gray-50 p-3 rounded-md">
            <p class="text-sm font-medium text-gray-900 mb-2">Séquence actuelle:</p>
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-2">
                <span 
                  class="px-2 py-1 text-xs rounded-full"
                  :class="$store.sequenceManagement.selectedImpaye && $store.sequenceManagement.selectedImpaye.sequence_is_automatic ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'"
                  x-text="$store.sequenceManagement.selectedImpaye ? ($store.sequenceManagement.selectedImpaye.sequence_name || 'Aucune séquence') : 'Aucune séquence'"
                ></span>
                <span x-show="$store.sequenceManagement.selectedImpaye && $store.sequenceManagement.selectedImpaye.sequence_is_automatic" class="text-purple-600">
                  <FileText class="w-4 h-4" />
                </span>
              </div>
              <button 
                x-show="$store.sequenceManagement.selectedImpaye && $store.sequenceManagement.selectedImpaye.sequence_id"
                @click="$store.sequenceManagement.assignSequenceToInvoice($store.sequenceManagement.selectedImpaye.objectId, null)"
                class="text-sm text-red-600 hover:text-red-800"
              >
                Retirer
              </button>
            </div>
          </div>
          
          <!-- Create new sequence -->
          <div class="bg-white border border-gray-200 rounded-md p-3">
            <p class="text-sm font-medium text-gray-900 mb-2">Créer une nouvelle séquence:</p>
            <div class="space-y-2">
              <input 
                type="text"
                placeholder="Nom de la séquence"
                x-model="$store.sequenceManagement.newSequenceName"
                class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-[#007ACE]"
                @keyup.enter="$store.sequenceManagement.createSequence($store.sequenceManagement.newSequenceName, $store.sequenceManagement.newSequenceIsAutomatic); $store.sequenceManagement.newSequenceName = ''"
              >
              <div class="flex items-center space-x-2">
                <label class="flex items-center text-sm">
                  <input type="checkbox" x-model="$store.sequenceManagement.newSequenceIsAutomatic" class="mr-2">
                  <span>Séquence automatique</span>
                </label>
                <button 
                  @click="$store.sequenceManagement.createSequence($store.sequenceManagement.newSequenceName, $store.sequenceManagement.newSequenceIsAutomatic); $store.sequenceManagement.newSequenceName = ''; $store.sequenceManagement.newSequenceIsAutomatic = false"
                  class="px-3 py-1 bg-[#00CF9B] text-white rounded-md hover:bg-[#00B887] text-sm transition-colors flex items-center space-x-1"
                  :disabled="!$store.sequenceManagement.newSequenceName || $store.sequenceManagement.newSequenceName.trim() === ''"
                >
                  <Minus class="w-4 h-4" />
                  <span>Créer</span>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Existing sequences list -->
          <div class="space-y-2">
            <p class="text-sm font-medium text-gray-900">Séquences existantes:</p>
            
            <template x-for="sequence in $store.sequenceManagement.sequences" :key="sequence.id">
              <div 
                class="bg-white border border-gray-200 rounded-md p-3 hover:bg-gray-50 transition-colors"
              >
                <div class="flex items-center justify-between">
                  <div class="flex items-center space-x-2">
                    <span 
                      class="px-2 py-1 text-xs rounded-full"
                      :class="sequence.is_automatic ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'"
                      x-text="sequence.name"
                    ></span>
                    <span x-show="sequence.is_automatic" class="text-purple-600">
                      <FileText class="w-4 h-4" />
                    </span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-500" x-text="sequence.createdAt ? $store.sequenceManagement.formatDate(sequence.createdAt) : 'Date inconnue'"></span>
                    <button 
                      @click.stop=""
                      class="text-gray-400 hover:text-gray-600"
                      title="Modifier"
                    >
                      <Settings class="w-4 h-4" />
                    </button>
                    <button 
                      @click="$store.sequenceManagement.selectedImpaye ? $store.sequenceManagement.assignSequenceToInvoice($store.sequenceManagement.selectedImpaye.objectId, sequence.id) : ''"
                      class="px-3 py-1 bg-[#007ACE] text-white rounded-md hover:bg-[#006BCE] text-sm transition-colors flex items-center space-x-1"
                      :disabled="$store.sequenceManagement.addingSequenceId === sequence.id"
                    >
                      <span x-show="$store.sequenceManagement.addingSequenceId !== sequence.id">Ajouter</span>
                      <span x-show="$store.sequenceManagement.addingSequenceId === sequence.id">
                        <span class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
                      </span>
                    </button>
                  </div>
                </div>
              </div>
            </template>
            
            <!-- No sequence option -->
            <div 
              x-show="$store.sequenceManagement.selectedImpaye"
              class="bg-white border border-gray-200 rounded-md p-3 hover:bg-gray-50 transition-colors cursor-pointer"
              @click="$store.sequenceManagement.assignSequenceToInvoice($store.sequenceManagement.selectedImpaye.objectId, null)"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-700">Sans séquence</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Drawer footer -->
      <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 bg-gray-50" data-sequence-footer>
        <div class="flex justify-end space-x-2">
          <button 
            @click="$store.sequenceManagement.close()"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm transition-colors"
          >
            Annuler
          </button>
          <button 
            x-show="$store.sequenceManagement.selectedImpaye"
            @click="$store.sequenceManagement.close()"
            class="px-4 py-2 bg-[#007ACE] text-white rounded-md hover:bg-[#006BCE] text-sm transition-colors"
          >
            Terminer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>