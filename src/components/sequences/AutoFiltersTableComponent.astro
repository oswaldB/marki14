<!--
  Composant de tableau avec filtres par colonne pour les séquences automatiques
  Affiche un tableau complet des impayés avec possibilité de filtrer chaque colonne
  Sauvegarde la requête complète dans la base de données
-->
---
import { Filter, Search, Trash2, Loader2, AlertTriangle, Eye, Save, X, ChevronDown, ChevronUp } from '@lucide/astro';
---

<div class="bg-white rounded-lg shadow p-6">
  <div x-data="autoFiltersTableComponent()"
       x-init="init()">

    <!-- En-tête -->
    <div class="flex justify-between items-center mb-4">
      <div class="flex items-center">
        <Filter class="w-5 h-5 text-blue-500 mr-2" />
        <h2 class="text-lg font-medium text-gray-900">Tableau des Impayés avec Filtres</h2>
      </div>
      <div class="flex items-center space-x-4">
        <span class="text-sm text-gray-500" x-text="`${activeFiltersCount} filtres actifs`"></span>
      </div>
    </div>

    <!-- Filtres actifs - Affichage uniquement des filtres actifs -->
    <div class="mb-6" x-show="activeFiltersCount > 0">
      <div class="bg-blue-50 border-l-4 border-blue-400 rounded p-4">
        <div class="flex items-start">
          <Filter class="h-5 w-5 text-blue-400 flex-shrink-0" />
          <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">Filtres actifs</h3>
            <div class="mt-2">
              <p class="text-sm text-blue-700">
                Voici l'ensemble des filtres actuellement actifs pour cette séquence :
              </p>
              <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                <template x-for="(filter, column) in activeFilters">
                  <div class="flex items-center justify-between p-2 bg-white border border-blue-200 rounded">
                    <div>
                      <span class="text-sm font-medium text-blue-600" x-text="column"></span>
                      <span class="text-xs text-gray-500 ml-2" x-text="getFilterDescription(filter)"></span>
                    </div>
                    <button class="text-red-500 hover:text-red-700" @click="clearColumnFilter(column)">
                      <Trash2 class="w-4 h-4" />
                    </button>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Force erase -->
    <div class="mb-6 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
      <div class="flex items-start">
        <AlertTriangle class="h-5 w-5 text-yellow-400 flex-shrink-0" />
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">Forcer le remplacement</h3>
          <div class="mt-2">
            <p class="text-sm text-yellow-700">
              Cette option permet d'inclure des impayés qui sont déjà dans une autre séquence.
            </p>
            <div class="mt-3 flex items-center">
              <input type="checkbox" class="h-4 w-4 text-yellow-600 focus:ring-yellow-500 border-gray-300 rounded"
                     x-model="forceErase"
                     @change="saveForceErase()">
              <label class="ml-2 block text-sm text-gray-900">
                <span class="font-medium">Forcer le remplacement des séquences existantes</span>
                <span class="text-xs text-gray-600 block">Si coché, les impayés seront retirés de leur séquence actuelle pour rejoindre cette séquence automatique.</span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Barre de recherche globale -->
    <div class="mb-4">
      <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <Search class="w-5 h-5 text-gray-400" />
        </div>
        <input type="text" placeholder="Rechercher dans toutes les colonnes..."
               class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
               x-model="globalSearchTerm"
               @input="applyGlobalSearch()">
      </div>
    </div>

    <!-- Tableau avec filtres par colonne -->
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <template x-for="column in visibleColumns">
              <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider relative group">
                <div class="flex items-center justify-between">
                  <span x-text="column"></span>
                  <div class="flex items-center">
                    <button class="p-1 rounded-full hover:bg-gray-200 text-gray-400 hover:text-gray-600"
                            @click="toggleColumnFilter(column)">
                      <Filter class="w-4 h-4" />
                    </button>
                    <button class="p-1 rounded-full hover:bg-gray-200 text-gray-400 hover:text-gray-600 ml-1"
                            @click="toggleColumnVisibility(column)">
                      <X class="w-4 h-4" />
                    </button>
                  </div>
                </div>
                <!-- Filtre de colonne (affiché sous l'en-tête) -->
                <div x-show="activeFilterColumn === column" class="absolute top-full left-0 right-0 bg-white border border-gray-200 rounded-md shadow-lg p-3 z-20 mt-1">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-sm font-medium text-gray-900" x-text="column"></h4>
                    <button class="text-gray-400 hover:text-gray-600" @click="activeFilterColumn = null">
                      <X class="w-4 h-4" />
                    </button>
                  </div>
                  
                  <!-- Sélecteur d'opérateur -->
                  <div class="mb-2">
                    <select class="block w-full pl-3 pr-10 py-1.5 text-sm border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 rounded-md"
                            x-model="getFilterOperator(column)"
                            @change="setFilterOperator(column, $event.target.value)">
                      <option value="equals">Égal à</option>
                      <option value="contains">Contient</option>
                      <option value="doesNotContain">Ne contient pas</option>
                      <option value="startsWith">Commence par</option>
                      <option value="endsWith">Finit par</option>
                      <option value="isEmpty">Est vide</option>
                      <option value="isNotEmpty">N'est pas vide</option>
                      <option value="greaterThan">Supérieur à</option>
                      <option value="lessThan">Inférieur à</option>
                      <option value="between">Entre</option>
                    </select>
                  </div>
                  
                  <!-- Champ de valeur (adapté à l'opérateur) -->
                  <div x-show="!isEmptyOperator(columnFilters[column]?.operator)">
                    <template x-if="columnFilters[column]?.operator === 'between'">
                      <div class="flex space-x-2">
                        <input type="text" placeholder="Min"
                               class="flex-1 pl-3 pr-3 py-1.5 border border-gray-300 rounded-md text-sm"
                               x-model="getFilterValueMin(column)"
                               @input="setFilterValueMin(column, $event.target.value)">
                        <input type="text" placeholder="Max"
                               class="flex-1 pl-3 pr-3 py-1.5 border border-gray-300 rounded-md text-sm"
                               x-model="getFilterValueMax(column)"
                               @input="setFilterValueMax(column, $event.target.value)">
                      </div>
                    </template>
                    <template x-if="columnFilters[column]?.operator !== 'between'">
                      <input type="text"
                             class="block w-full pl-3 pr-10 py-1.5 border border-gray-300 rounded-md text-sm"
                             x-model="getFilterValue(column)"
                             @input="setFilterValue(column, $event.target.value)"
                             :placeholder="getOperatorPlaceholder(columnFilters[column]?.operator)">
                    </template>
                  </div>
                  
                  <div class="flex justify-end space-x-2 mt-3">
                    <button class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800"
                            @click="clearColumnFilter(column)">
                      Effacer
                    </button>
                    <button class="px-3 py-1 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-md"
                            @click="applyColumnFilter(column)">
                      Appliquer
                    </button>
                  </div>
                </div>
              </th>
            </template>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <template x-for="(invoice, index) in filteredInvoices" :key="invoice.objectId">
            <tr class="hover:bg-gray-50">
              <template x-for="column in visibleColumns">
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-500" x-text="formatCellValue(invoice[column], column)"></td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- Boutons d'action -->
    <div class="mt-6 flex justify-between items-center">
      <div>
        <button class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                @click="resetAllFilters()">
          Réinitialiser tout
        </button>
      </div>
      <div class="flex space-x-3">
        <button class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
                @click="loadMoreInvoices()" :disabled="isLoadingMore">
          <span x-show="!isLoadingMore">Charger plus</span>
          <span x-show="isLoadingMore">
            <Loader2 class="w-4 h-4 mr-2 inline animate-spin" />
            Chargement...
          </span>
        </button>
        <button class="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-[#007ACE] hover:bg-[#006BCE]"
                @click="saveAllFilters()" :disabled="isSaving">
          <span x-show="!isSaving">
            <Save class="w-4 h-4 mr-2 inline" />
            Enregistrer la requête
          </span>
          <span x-show="isSaving">
            <Loader2 class="w-4 h-4 mr-2 inline animate-spin" />
            Sauvegarde...
          </span>
        </button>
      </div>
    </div>


  </div>
</div>

<script>
// Ce composant nécessite le JavaScript associé pour fonctionner
console.log('AutoFiltersTableComponent chargé - JavaScript requis');
</script>